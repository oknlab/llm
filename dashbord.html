<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite RAG Multi-Agent Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0a0e27;
            --bg-card: #131829;
            --bg-hover: #1a1f3a;
            --accent-blue: #00d4ff;
            --accent-purple: #b47aff;
            --accent-green: #00ff88;
            --accent-red: #ff4757;
            --accent-orange: #ffa502;
            --text-primary: #e0e6ff;
            --text-secondary: #8b92b8;
            --border: #2a3150;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0d1224 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* HEADER */
        .header {
            background: rgba(19, 24, 41, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-bar {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }

        /* MAIN LAYOUT */
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 2rem;
        }

        .grid {
            display: grid;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        }

        .grid-full {
            grid-template-columns: 1fr;
        }

        /* CARDS */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: var(--accent-blue);
            box-shadow: 0 8px 30px rgba(0, 212, 255, 0.15);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent-blue);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-badge {
            background: var(--bg-hover);
            color: var(--accent-green);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* AGENT GRID */
        .agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .agent-card {
            background: var(--bg-hover);
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .agent-card:hover {
            border-color: var(--accent-purple);
            transform: scale(1.05);
        }

        .agent-card.active {
            border-color: var(--accent-green);
            background: rgba(0, 255, 136, 0.1);
        }

        .agent-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .agent-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-purple);
            margin-bottom: 0.3rem;
        }

        .agent-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* INPUT AREA */
        textarea {
            width: 100%;
            min-height: 150px;
            padding: 1rem;
            background: var(--bg-hover);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        /* BUTTONS */
        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 2rem;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--bg-hover);
            border: 2px solid var(--accent-blue);
        }

        /* INTEGRATION GRID */
        .integration-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }

        .integration-item {
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .integration-item:hover {
            border-color: var(--accent-blue);
            transform: translateY(-3px);
        }

        .integration-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .integration-name {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .integration-status {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.3rem;
        }

        .integration-status.connected {
            color: var(--accent-green);
        }

        /* RESPONSE AREA */
        .response-card {
            background: var(--bg-hover);
            border-left: 4px solid var(--accent-green);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .response-agent {
            font-weight: 700;
            color: var(--accent-purple);
            font-size: 1.1rem;
        }

        .response-confidence {
            background: var(--bg-card);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .response-content {
            color: var(--text-primary);
            line-height: 1.7;
            white-space: pre-wrap;
            margin-bottom: 1rem;
        }

        .response-meta {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* METRICS */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .metric-card {
            background: var(--bg-hover);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--accent-blue);
            margin-bottom: 0.3rem;
        }

        .metric-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* LOADING */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid var(--border);
            border-top: 4px solid var(--accent-blue);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* AIRFLOW DAG VIEWER */
        .dag-list {
            list-style: none;
        }

        .dag-item {
            background: var(--bg-hover);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dag-name {
            font-weight: 600;
            color: var(--accent-blue);
        }

        .dag-actions {
            display: flex;
            gap: 0.5rem;
        }

        .dag-btn {
            padding: 0.4rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--accent-blue);
            border-radius: 5px;
            color: var(--accent-blue);
            cursor: pointer;
            font-size: 0.85rem;
        }

        .dag-btn:hover {
            background: var(--accent-blue);
            color: white;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }

            .status-bar {
                flex-direction: column;
                gap: 0.5rem;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                🔷 ELITE RAG MULTI-AGENT SYSTEM
            </div>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span id="systemStatus">System Operational</span>
                </div>
                <div class="status-item">
                    <span>📊 Model: <strong id="modelName">Loading...</strong></span>
                </div>
                <div class="status-item">
                    <span>🗄️ Docs: <strong id="vectorDbCount">0</strong></span>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN CONTAINER -->
    <div class="container">
        <!-- METRICS ROW -->
        <div class="grid grid-full">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">📈 System Metrics</div>
                </div>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="totalQueries">0</div>
                        <div class="metric-label">Total Queries</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="avgConfidence">0%</div>
                        <div class="metric-label">Avg Confidence</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="webScrapes">0</div>
                        <div class="metric-label">Web Scrapes</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="activeIntegrations">0</div>
                        <div class="metric-label">Active Integrations</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AGENTS SECTION -->
        <div class="grid grid-full">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">🤖 AI Agents</div>
                    <div class="card-badge">6 Available</div>
                </div>
                <div class="agent-grid">
                    <div class="agent-card active" data-agent="CodeArchitect">
                        <div class="agent-icon">⚙️</div>
                        <div class="agent-name">CodeArchitect</div>
                        <div class="agent-desc">Software Engineering</div>
                    </div>
                    <div class="agent-card" data-agent="SecAnalyst">
                        <div class="agent-icon">🔒</div>
                        <div class="agent-name">SecAnalyst</div>
                        <div class="agent-desc">Security Analysis</div>
                    </div>
                    <div class="agent-card" data-agent="AutoBot">
                        <div class="agent-icon">🔄</div>
                        <div class="agent-name">AutoBot</div>
                        <div class="agent-desc">Automation Expert</div>
                    </div>
                    <div class="agent-card" data-agent="AgentSuite">
                        <div class="agent-icon">📊</div>
                        <div class="agent-name">AgentSuite</div>
                        <div class="agent-desc">Administrative Ops</div>
                    </div>
                    <div class="agent-card" data-agent="CreativeAgent">
                        <div class="agent-icon">🎨</div>
                        <div class="agent-name">CreativeAgent</div>
                        <div class="agent-desc">Content Creation</div>
                    </div>
                    <div class="agent-card" data-agent="AgCustom">
                        <div class="agent-icon">🎯</div>
                        <div class="agent-name">AgCustom</div>
                        <div class="agent-desc">Custom Solutions</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- QUERY INTERFACE -->
        <div class="grid grid-2">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">💬 Query Interface</div>
                </div>
                <textarea id="queryInput" placeholder="Enter your query here...

Examples:
- Build a FastAPI authentication system
- Analyze security vulnerabilities in OAuth flows
- Design an automation workflow for data pipelines
- Create a financial report template
- Write marketing copy for AI product
- Build a custom agent for supply chain optimization"></textarea>
                <div class="btn-group">
                    <button class="btn" id="executeBtn">Execute Query</button>
                    <button class="btn btn-secondary" id="webScrapeBtn">Web Search + Index</button>
                    <button class="btn btn-secondary" id="clearBtn">Clear</button>
                </div>
            </div>

            <!-- INTEGRATIONS -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">🔗 Integrations</div>
                    <div class="card-badge" id="integrationCount">0 Active</div>
                </div>
                <div class="integration-grid">
                    <div class="integration-item" data-integration="slack">
                        <div class="integration-icon">💬</div>
                        <div class="integration-name">Slack</div>
                        <div class="integration-status" id="slack-status">Disconnected</div>
                    </div>
                    <div class="integration-item" data-integration="notion">
                        <div class="integration-icon">📝</div>
                        <div class="integration-name">Notion</div>
                        <div class="integration-status" id="notion-status">Disconnected</div>
                    </div>
                    <div class="integration-item" data-integration="github">
                        <div class="integration-icon">🐙</div>
                        <div class="integration-name">GitHub</div>
                        <div class="integration-status" id="github-status">Disconnected</div>
                    </div>
                    <div class="integration-item" data-integration="n8n">
                        <div class="integration-icon">🔄</div>
                        <div class="integration-name">n8n</div>
                        <div class="integration-status" id="n8n-status">Disconnected</div>
                    </div>
                    <div class="integration-item" data-integration="zapier">
                        <div class="integration-icon">⚡</div>
                        <div class="integration-name">Zapier</div>
                        <div class="integration-status" id="zapier-status">Disconnected</div>
                    </div>
                    <div class="integration-item" data-integration="manufacturing">
                        <div class="integration-icon">🏭</div>
                        <div class="integration-name">Manufacturing</div>
                        <div class="integration-status" id="manufacturing-status">Disconnected</div>
                    </div>
                    <div class="integration-item" data-integration="erp">
                        <div class="integration-icon">📦</div>
                        <div class="integration-name">ERP System</div>
                        <div class="integration-status" id="erp-status">Disconnected</div>
                    </div>
                    <div class="integration-item" data-integration="mlflow">
                        <div class="integration-icon">🧪</div>
                        <div class="integration-name">MLflow</div>
                        <div class="integration-status" id="mlflow-status">Disconnected</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AIRFLOW DAGS -->
        <div class="grid grid-full">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">📊 Airflow DAGs</div>
                    <div class="card-badge">Workflow Orchestration</div>
                </div>
                <ul class="dag-list">
                    <li class="dag-item">
                        <div>
                            <div class="dag-name">RAG Knowledge Base Sync</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">Syncs knowledge bases every 6 hours</div>
                        </div>
                        <div class="dag-actions">
                            <button class="dag-btn" onclick="generateDAG('rag_sync')">View Code</button>
                        </div>
                    </li>
                    <li class="dag-item">
                        <div>
                            <div class="dag-name">Manufacturing Pipeline</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">Manages production & 3D printing</div>
                        </div>
                        <div class="dag-actions">
                            <button class="dag-btn" onclick="generateDAG('manufacturing')">View Code</button>
                        </div>
                    </li>
                </ul>
            </div>
        </div>

        <!-- LOADING INDICATOR -->
        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            <p style="color: var(--text-secondary);">Processing with AI agents...</p>
        </div>

        <!-- RESPONSE AREA -->
        <div class="grid grid-full">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">📝 Agent Responses</div>
                </div>
                <div id="responsesContainer">
                    <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                        No responses yet. Execute a query to begin.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        // STATE
        const state = {
            selectedAgent: 'CodeArchitect',
            queryCount: 0,
            totalConfidence: 0,
            scrapeCount: 0
        };

        // INITIALIZATION
        document.addEventListener('DOMContentLoaded', async () => {
            await loadHealthStatus();
            setupEventListeners();
            setInterval(updateMetrics, 10000); // Update every 10s
        });

        // HEALTH STATUS
        async function loadHealthStatus() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                document.getElementById('modelName').textContent = data.model.split('/').pop();
                document.getElementById('vectorDbCount').textContent = data.vector_db_docs;
                
                // Update integration statuses
                Object.entries(data.integrations).forEach(([key, connected]) => {
                    const statusEl = document.getElementById(`${key}-status`);
                    if (statusEl) {
                        statusEl.textContent = connected ? 'Connected' : 'Disconnected';
                        if (connected) statusEl.classList.add('connected');
                    }
                });
                
                const activeCount = Object.values(data.integrations).filter(v => v).length;
                document.getElementById('integrationCount').textContent = `${activeCount} Active`;
                document.getElementById('activeIntegrations').textContent = activeCount;
                
            } catch (error) {
                console.error('Health check failed:', error);
            }
        }

        // EVENT LISTENERS
        function setupEventListeners() {
            // Agent selection
            document.querySelectorAll('.agent-card').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('.agent-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    state.selectedAgent = card.dataset.agent;
                });
            });

            // Execute query
            document.getElementById('executeBtn').addEventListener('click', executeQuery);

            // Web scrape
            document.getElementById('webScrapeBtn').addEventListener('click', webScrape);

            // Clear
            document.getElementById('clearBtn').addEventListener('click', () => {
                document.getElementById('queryInput').value = '';
            });

            // Enter key
            document.getElementById('queryInput').addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'Enter') {
                    executeQuery();
                }
            });
        }

        // EXECUTE QUERY
        async function executeQuery() {
            const query = document.getElementById('queryInput').value.trim();
            
            if (!query) {
                alert('Please enter a query');
                return;
            }

            const loading = document.getElementById('loadingIndicator');
            const btn = document.getElementById('executeBtn');
            
            loading.classList.add('active');
            btn.disabled = true;

            try {
                const response = await fetch('/query', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        query: query,
                        agent: state.selectedAgent,
                        enable_web_search: true
                    })
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                displayResponse(data);
                
                // Update state
                state.queryCount++;
                state.totalConfidence += data.confidence;
                updateMetrics();

            } catch (error) {
                console.error('Query failed:', error);
                alert('Query execution failed. Check console.');
            } finally {
                loading.classList.remove('active');
                btn.disabled = false;
            }
        }

        // WEB SCRAPE
        async function webScrape() {
            const query = document.getElementById('queryInput').value.trim();
            
            if (!query) {
                alert('Please enter a search query');
                return;
            }

            const loading = document.getElementById('loadingIndicator');
            loading.classList.add('active');

            try {
                const response = await fetch(`/web-scrape?query=${encodeURIComponent(query)}&max_results=10`, {
                    method: 'POST'
                });

                const data = await response.json();
                alert(`✓ Scraped ${data.documents_scraped} documents and indexed to vector DB`);
                
                state.scrapeCount += data.documents_scraped;
                await loadHealthStatus();
                updateMetrics();

            } catch (error) {
                console.error('Scraping failed:', error);
                alert('Web scraping failed');
            } finally {
                loading.classList.remove('active');
            }
        }

        // DISPLAY RESPONSE
        function displayResponse(data) {
            const container = document.getElementById('responsesContainer');
            
            const card = document.createElement('div');
            card.className = 'response-card';
            
            const confidence = (data.confidence * 100).toFixed(1);
            const confidenceColor = confidence > 80 ? 'var(--accent-green)' : 
                                   confidence > 60 ? 'var(--accent-orange)' : 'var(--accent-red)';
            
            card.innerHTML = `
                <div class="response-header">
                    <div class="response-agent">${getAgentIcon(data.agent)} ${data.agent}</div>
                    <div class="response-confidence" style="color: ${confidenceColor}">
                        Confidence: ${confidence}%
                    </div>
                </div>
                <div class="response-content">${escapeHtml(data.response)}</div>
                <div class="response-meta">
                    <span><strong>Sources:</strong> ${data.sources.length}</span>
                    <span><strong>Iterations:</strong> ${data.iterations}</span>
                    <span><strong>Timestamp:</strong> ${new Date(data.timestamp).toLocaleString()}</span>
                    ${data.metadata.scraped_urls ? `<span><strong>Web Scrapes:</strong> ${data.metadata.scraped_urls}</span>` : ''}
                </div>
            `;
            
            container.insertBefore(card, container.firstChild);
            
            // Keep only last 10 responses
            while (container.children.length > 10) {
                container.removeChild(container.lastChild);
            }
        }

        // GENERATE DAG
        async function generateDAG(dagType) {
            try {
                const response = await fetch('/airflow/dag/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({dag_type: dagType})
                });

                const code = await response.text();
                
                // Show in modal or new window
                const win = window.open('', 'DAG Code', 'width=800,height=600');
                win.document.write(`<pre style="background: #1e1e1e; color: #d4d4d4; padding: 20px; font-family: monospace;">${escapeHtml(code)}</pre>`);
                
            } catch (error) {
                console.error('DAG generation failed:', error);
                alert('Failed to generate DAG');
            }
        }

        // UPDATE METRICS
        function updateMetrics() {
            document.getElementById('totalQueries').textContent = state.queryCount;
            document.getElementById('avgConfidence').textContent = 
                state.queryCount > 0 ? 
                ((state.totalConfidence / state.queryCount) * 100).toFixed(1) + '%' : '0%';
            document.getElementById('webScrapes').textContent = state.scrapeCount;
        }

        // HELPERS
        function getAgentIcon(agent) {
            const icons = {
                'CodeArchitect': '⚙️',
                'SecAnalyst': '🔒',
                'AutoBot': '🔄',
                'AgentSuite': '📊',
                'CreativeAgent': '🎨',
                'AgCustom': '🎯'
            };
            return icons[agent] || '🤖';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
