<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Core Dashboard</title>
    <style>
        :root { --bg-color: #121212; --text-color: #E0E0E0; --primary-color: #00A67E; --secondary-color: #2a2a2a; --border-color: #444; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 2rem; display: flex; flex-direction: column; gap: 2rem; }
        header, main { max-width: 900px; width: 100%; margin: 0 auto; }
        h1, h2 { color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
        .container { background-color: var(--secondary-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem; }
        #status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .status-item { background: #333; padding: 1rem; border-radius: 4px; }
        .status-item strong { display: block; color: var(--primary-color); margin-bottom: 0.5rem; font-size: 0.9rem; }
        #prompt-form { display: flex; flex-direction: column; gap: 1rem; }
        textarea { width: 100%; min-height: 120px; background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.8rem; font-size: 1rem; resize: vertical; }
        button { background-color: var(--primary-color); color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 4px; font-size: 1rem; cursor: pointer; align-self: flex-start; transition: background-color 0.2s; }
        button:hover { background-color: #008768; }
        button:disabled { background-color: #555; cursor: not-allowed; }
        #response-container { margin-top: 1rem; background-color: #0a0a0a; border: 1px solid var(--border-color); border-radius: 4px; padding: 1.5rem; min-height: 100px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', Courier, monospace; }
        .loader { text-align: center; color: var(--primary-color); }
    </style>
</head>
<body>

    <header>
        <h1>AI Core - Agentic Platform</h1>
    </header>

    <main>
        <div class="container">
            <h2>System Status</h2>
            <div id="status-grid"></div>
        </div>

        <div class="container">
            <h2>Invoke Agent Workflow</h2>
            <form id="prompt-form">
                <textarea id="prompt-input" placeholder="Enter your task... e.g., 'Write a Python script using FastAPI to serve a 'hello world' message. Use the web_search_rag tool to find the latest documentation.'" required></textarea>
                <button type="submit" id="submit-button">Execute</button>
            </form>
            <div id="response-container">Agent output will appear here...</div>
        </div>
    </main>

    <script>
        const API_URL = window.location.origin; // Assumes dashboard is served via ngrok
        const statusGrid = document.getElementById('status-grid');
        const promptForm = document.getElementById('prompt-form');
        const promptInput = document.getElementById('prompt-input');
        const submitButton = document.getElementById('submit-button');
        const responseContainer = document.getElementById('response-container');

        // Fetch and display system status
        async function fetchStatus() {
            try {
                const response = await fetch(`${API_URL}/status`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                statusGrid.innerHTML = `
                    <div class="status-item"><strong>Status</strong><span>${data.status.toUpperCase()}</span></div>
                    <div class="status-item"><strong>Model ID</strong><span>${data.model_id}</span></div>
                    <div class="status-item"><strong>CPU Load (1m)</strong><span>${data.cpu_load['1min']?.toFixed(2) || 'N/A'}</span></div>
                    <div class="status-item"><strong>Memory</strong><span>${data.memory_usage.used_mb || 'N/A'} / ${data.memory_usage.total_mb || 'N/A'} MB</span></div>
                `;
            } catch (error) {
                statusGrid.innerHTML = `<div class="status-item"><strong>Error</strong><span>Could not fetch status. Is the server running?</span></div>`;
                console.error("Error fetching status:", error);
            }
        }

        // Handle form submission and stream response
        promptForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const prompt = promptInput.value;
            if (!prompt) return;

            submitButton.disabled = true;
            submitButton.textContent = 'Executing...';
            responseContainer.innerHTML = '<div class="loader">Awaiting response from agent...</div>';

            try {
                const eventSource = new EventSource(`${API_URL}/invoke`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt })
                });

                let fullResponse = '';
                responseContainer.innerHTML = ''; // Clear loader

                eventSource.onmessage = (event) => {
                    if (event.data === "[END_OF_STREAM]") {
                        eventSource.close();
                        submitButton.disabled = false;
                        submitButton.textContent = 'Execute';
                        if (fullResponse === '') {
                           responseContainer.textContent = 'Agent finished without generating text output.';
                        }
                        return;
                    }
                    // The data is already a string, no need for JSON.parse
                    fullResponse += event.data;
                    responseContainer.textContent = fullResponse;
                };

                eventSource.onerror = (err) => {
                    console.error("EventSource failed:", err);
                    responseContainer.textContent = 'Error receiving stream from server.';
                    eventSource.close();
                    submitButton.disabled = false;
                    submitButton.textContent = 'Execute';
                };

            } catch (error) {
                responseContainer.textContent = `Error: ${error.message}`;
                submitButton.disabled = false;
                submitButton.textContent = 'Execute';
                console.error("Error invoking agent:", error);
            }
        });

        // Initial load
        fetchStatus();
        setInterval(fetchStatus, 30000); // Refresh status every 30 seconds
    </script>
</body>
</html>
